# Product Requirements Document: Paper2Any User System (Minimal v1)

## Overview

Add user authentication and usage limiting to Paper2Any using Supabase.

## Technical Stack

- **Auth & Database**: Supabase (Auth + PostgreSQL + Storage)
- **Frontend**: React + Vite (frontend-workflow/) - direct Supabase client
- **Backend**: FastAPI (fastapi_app/) - JWT verification only

## Database Schema

Only 2 custom tables (auth.users is built-in):

```sql
-- Track daily usage per user
CREATE TABLE usage_records (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  workflow_type TEXT NOT NULL,
  called_at TIMESTAMPTZ DEFAULT now()
);

-- Track user files
CREATE TABLE user_files (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  file_path TEXT NOT NULL,
  file_name TEXT NOT NULL,
  file_size BIGINT,
  workflow_type TEXT,
  created_at TIMESTAMPTZ DEFAULT now()
);

-- RLS: users only see their own data
ALTER TABLE usage_records ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_files ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users read own usage" ON usage_records FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users insert own usage" ON usage_records FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users read own files" ON user_files FOR ALL USING (auth.uid() = user_id);
```

## Frontend Requirements

### Auth (use Supabase client directly)
- Login page: email + password form
- Register page: email + password + confirmation
- Call `supabase.auth.signInWithPassword()` / `signUp()` / `signOut()`
- Store session in Zustand, persist to localStorage

### Protected Routes
- Check auth state, redirect to /login if not authenticated
- Pass JWT token in Authorization header for API calls

### Usage Display
- Show "剩余次数: X/10" in header
- Disable workflow button when quota = 0

### File List
- Simple table: filename, size, date, download button
- Delete button per file

## Backend Requirements

### Auth Middleware
- Verify Supabase JWT from Authorization header
- Extract user_id, attach to request state
- Return 401 if invalid/missing token

### Rate Limit Check (before workflow execution)
```python
# Pseudo-code
today_count = db.query(usage_records)
    .filter(user_id=current_user, DATE(called_at)=today)
    .count()

if today_count >= 10:
    raise HTTPException(429, "Daily limit reached")
```

### After Workflow Success
1. Upload output file to Supabase Storage: `user_files/{user_id}/{timestamp}_{filename}`
2. Insert record to user_files table
3. Insert record to usage_records table
4. Return file download URL

### API Endpoints
- GET /api/quota - returns `{used: N, limit: 10}`
- GET /api/files - returns user's file list
- DELETE /api/files/{id} - delete file from storage + table

## Out of Scope (v1)

- OAuth (Google/GitHub)
- Password reset (use Supabase default)
- Email verification (use Supabase default)
- User profile/display name
- Admin dashboard
- Auto file cleanup (manual for now)
- Usage history

## Success Criteria

- User can register, login, logout
- Unauthenticated users cannot access workflows
- Users limited to 10 workflow calls per day
- Generated files saved and downloadable
