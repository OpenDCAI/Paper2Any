# Product Requirements Document: Paper2Any User Management System

## Overview

Build a user authentication, rate limiting, and file management system for Paper2Any using Supabase as the backend database. The system integrates with the existing React frontend and FastAPI backend.

## Goals

1. Enable user registration and login for Paper2Any
2. Limit workflow usage to prevent abuse (10 calls/day per user)
3. Persist user-generated files with 30-day retention
4. Provide a foundation for future monetization

## Technical Stack

- **Database**: Supabase (PostgreSQL)
- **Auth**: Supabase Auth (Email/Password + OAuth)
- **Storage**: Supabase Storage (for user files)
- **Frontend**: React (frontend-workflow/)
- **Backend**: FastAPI (fastapi_app/)

## Functional Requirements

### 1. User Authentication

#### 1.1 Email/Password Registration
- User provides email and password
- Email verification required before activation
- Password requirements: minimum 8 characters

#### 1.2 OAuth Social Login
- Google OAuth integration
- GitHub OAuth integration
- Auto-create user profile on first OAuth login

#### 1.3 Session Management
- JWT-based authentication via Supabase
- Token refresh mechanism
- Logout functionality

### 2. Rate Limiting System

#### 2.1 Usage Tracking
- Track workflow calls per user per day
- Store usage records in Supabase table
- Reset counter daily at midnight UTC

#### 2.2 Limit Enforcement
- Default limit: 10 workflow calls per day
- Return 429 error when limit exceeded
- Show remaining quota in API response headers

#### 2.3 Usage Dashboard
- Display current usage count to user
- Show reset time
- Usage history (optional)

### 3. File Management

#### 3.1 File Storage
- Store generated files (PPT, PDF, Video) in Supabase Storage
- Organize by user_id/workflow_type/timestamp
- Maximum file size: 100MB per file

#### 3.2 File Retention
- Auto-delete files after 30 days
- Supabase scheduled function for cleanup
- User can manually delete files earlier

#### 3.3 File Access
- Authenticated download URLs
- List user's files with metadata
- File preview (for supported formats)

### 4. Database Schema

#### 4.1 Tables

**users** (managed by Supabase Auth)
- id (uuid, primary key)
- email
- created_at
- last_sign_in_at

**user_profiles**
- id (uuid, references auth.users)
- display_name
- avatar_url
- created_at
- updated_at

**usage_records**
- id (uuid, primary key)
- user_id (uuid, references auth.users)
- workflow_type (text)
- called_at (timestamp)
- date (date, for daily aggregation)

**user_files**
- id (uuid, primary key)
- user_id (uuid, references auth.users)
- file_path (text)
- file_name (text)
- file_type (text)
- file_size (bigint)
- workflow_type (text)
- created_at (timestamp)
- expires_at (timestamp)

#### 4.2 Row Level Security (RLS)
- Users can only access their own records
- Enable RLS on all tables

### 5. API Endpoints

#### 5.1 Auth Endpoints (via Supabase client)
- POST /auth/signup - Email registration
- POST /auth/login - Email login
- POST /auth/logout - Logout
- GET /auth/user - Get current user
- POST /auth/oauth/{provider} - OAuth redirect

#### 5.2 Usage Endpoints
- GET /api/usage/quota - Get remaining quota
- GET /api/usage/history - Get usage history

#### 5.3 File Endpoints
- GET /api/files - List user files
- GET /api/files/{file_id}/download - Download file
- DELETE /api/files/{file_id} - Delete file

### 6. Frontend Integration

#### 6.1 Auth UI Components
- Login page with email/password form
- Registration page
- OAuth buttons (Google, GitHub)
- Password reset flow

#### 6.2 Protected Routes
- Redirect unauthenticated users to login
- Store auth state in Zustand

#### 6.3 Usage Display
- Show quota in header/sidebar
- Warning when approaching limit
- Block action when limit reached

#### 6.4 File Management UI
- File list page
- Download buttons
- Delete confirmation

### 7. Backend Integration

#### 7.1 Auth Middleware
- Verify Supabase JWT on protected endpoints
- Extract user_id from token
- Pass user context to workflow handlers

#### 7.2 Rate Limit Middleware
- Check usage count before workflow execution
- Increment counter after successful execution
- Return appropriate error when exceeded

#### 7.3 File Save Hook
- After workflow completion, upload output to Supabase Storage
- Create record in user_files table
- Return file URL to frontend

## Non-Functional Requirements

### Security
- All API endpoints require authentication (except public pages)
- HTTPS only
- No sensitive data in logs

### Performance
- Auth checks < 100ms
- File uploads support up to 100MB

### Scalability
- Supabase handles scaling automatically
- Consider connection pooling for high traffic

## Out of Scope (v1)

- Admin dashboard
- Multiple user roles/tiers
- Payment integration
- API key authentication
- Team/organization features

## Success Metrics

- User registration completion rate > 80%
- Average login time < 2 seconds
- Zero unauthorized data access incidents
