{
  "master": {
    "tasks": [
      {
        "id": 1,
        "title": "Setup Supabase Project and Database Schema",
        "description": "Create a new Supabase project and implement the database schema with all required tables (user_profiles, usage_records, user_files) along with Row Level Security (RLS) policies.",
        "details": "## Implementation Steps\n\n1. **Create Supabase Project**\n   - Sign up at supabase.com and create a new project\n   - Save the project URL and anon key for environment configuration\n\n2. **Create Database Tables via Supabase SQL Editor**\n\n```sql\n-- user_profiles table\nCREATE TABLE public.user_profiles (\n  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,\n  display_name TEXT,\n  avatar_url TEXT,\n  created_at TIMESTAMPTZ DEFAULT NOW(),\n  updated_at TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- usage_records table\nCREATE TABLE public.usage_records (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,\n  workflow_type TEXT NOT NULL,\n  called_at TIMESTAMPTZ DEFAULT NOW(),\n  date DATE DEFAULT CURRENT_DATE\n);\n\n-- Create index for efficient daily queries\nCREATE INDEX idx_usage_records_user_date ON public.usage_records(user_id, date);\n\n-- user_files table\nCREATE TABLE public.user_files (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,\n  file_path TEXT NOT NULL,\n  file_name TEXT NOT NULL,\n  file_type TEXT NOT NULL,\n  file_size BIGINT NOT NULL,\n  workflow_type TEXT NOT NULL,\n  created_at TIMESTAMPTZ DEFAULT NOW(),\n  expires_at TIMESTAMPTZ DEFAULT (NOW() + INTERVAL '30 days')\n);\n\n-- Create index for file expiration cleanup\nCREATE INDEX idx_user_files_expires_at ON public.user_files(expires_at);\n```\n\n3. **Enable Row Level Security**\n\n```sql\n-- Enable RLS on all tables\nALTER TABLE public.user_profiles ENABLE ROW LEVEL SECURITY;\nALTER TABLE public.usage_records ENABLE ROW LEVEL SECURITY;\nALTER TABLE public.user_files ENABLE ROW LEVEL SECURITY;\n\n-- user_profiles policies\nCREATE POLICY \"Users can view own profile\" ON public.user_profiles\n  FOR SELECT USING (auth.uid() = id);\nCREATE POLICY \"Users can update own profile\" ON public.user_profiles\n  FOR UPDATE USING (auth.uid() = id);\nCREATE POLICY \"Users can insert own profile\" ON public.user_profiles\n  FOR INSERT WITH CHECK (auth.uid() = id);\n\n-- usage_records policies\nCREATE POLICY \"Users can view own usage\" ON public.usage_records\n  FOR SELECT USING (auth.uid() = user_id);\nCREATE POLICY \"Users can insert own usage\" ON public.usage_records\n  FOR INSERT WITH CHECK (auth.uid() = user_id);\n\n-- user_files policies\nCREATE POLICY \"Users can view own files\" ON public.user_files\n  FOR SELECT USING (auth.uid() = user_id);\nCREATE POLICY \"Users can insert own files\" ON public.user_files\n  FOR INSERT WITH CHECK (auth.uid() = user_id);\nCREATE POLICY \"Users can delete own files\" ON public.user_files\n  FOR DELETE USING (auth.uid() = user_id);\n```\n\n4. **Create trigger for auto-creating user_profiles**\n\n```sql\n-- Function to create profile on signup\nCREATE OR REPLACE FUNCTION public.handle_new_user()\nRETURNS TRIGGER AS $$\nBEGIN\n  INSERT INTO public.user_profiles (id, display_name, avatar_url)\n  VALUES (\n    NEW.id,\n    COALESCE(NEW.raw_user_meta_data->>'full_name', NEW.email),\n    NEW.raw_user_meta_data->>'avatar_url'\n  );\n  RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER;\n\n-- Trigger on auth.users\nCREATE TRIGGER on_auth_user_created\n  AFTER INSERT ON auth.users\n  FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();\n```\n\n5. **Create Supabase Storage Bucket**\n   - Create bucket named 'user-files' in Supabase dashboard\n   - Set up storage policies for authenticated user access\n\n```sql\n-- Storage policies\nCREATE POLICY \"Users can upload own files\"\n  ON storage.objects FOR INSERT\n  WITH CHECK (bucket_id = 'user-files' AND auth.uid()::text = (storage.foldername(name))[1]);\n\nCREATE POLICY \"Users can view own files\"\n  ON storage.objects FOR SELECT\n  USING (bucket_id = 'user-files' AND auth.uid()::text = (storage.foldername(name))[1]);\n\nCREATE POLICY \"Users can delete own files\"\n  ON storage.objects FOR DELETE\n  USING (bucket_id = 'user-files' AND auth.uid()::text = (storage.foldername(name))[1]);\n```",
        "testStrategy": "1. Verify all tables created successfully via Supabase dashboard\n2. Test RLS by attempting to access another user's data (should fail)\n3. Test trigger by creating a new user and verifying profile auto-created\n4. Test storage bucket policies with test file upload/download\n5. Run SQL queries to validate indexes exist",
        "priority": "high",
        "dependencies": [],
        "status": "pending",
        "subtasks": []
      },
      {
        "id": 2,
        "title": "Configure Backend Supabase Client and Environment",
        "description": "Install Supabase Python SDK and create a reusable client module for the FastAPI backend with proper environment variable configuration.",
        "details": "## Implementation Steps\n\n1. **Install Supabase Python SDK**\n\nAdd to requirements.txt or pyproject.toml:\n```\nsupabase>=2.0.0\npython-jose[cryptography]>=3.3.0  # For JWT verification\n```\n\n2. **Create environment configuration file**\n\nCreate `fastapi_app/config.py`:\n```python\nfrom functools import lru_cache\nfrom pydantic_settings import BaseSettings\n\nclass Settings(BaseSettings):\n    # Supabase configuration\n    supabase_url: str = \"\"\n    supabase_anon_key: str = \"\"\n    supabase_service_role_key: str = \"\"  # For admin operations\n    supabase_jwt_secret: str = \"\"\n    \n    # Rate limiting\n    daily_workflow_limit: int = 10\n    \n    # File retention\n    file_retention_days: int = 30\n    max_file_size_mb: int = 100\n    \n    class Config:\n        env_file = \".env\"\n        env_file_encoding = \"utf-8\"\n\n@lru_cache()\ndef get_settings() -> Settings:\n    return Settings()\n```\n\n3. **Create Supabase client module**\n\nCreate `fastapi_app/supabase_client.py`:\n```python\nfrom supabase import create_client, Client\nfrom fastapi_app.config import get_settings\n\n_supabase_client: Client | None = None\n_supabase_admin_client: Client | None = None\n\ndef get_supabase_client() -> Client:\n    \"\"\"Get Supabase client for user operations (respects RLS)\"\"\"\n    global _supabase_client\n    if _supabase_client is None:\n        settings = get_settings()\n        _supabase_client = create_client(\n            settings.supabase_url,\n            settings.supabase_anon_key\n        )\n    return _supabase_client\n\ndef get_supabase_admin_client() -> Client:\n    \"\"\"Get Supabase admin client for server-side operations (bypasses RLS)\"\"\"\n    global _supabase_admin_client\n    if _supabase_admin_client is None:\n        settings = get_settings()\n        _supabase_admin_client = create_client(\n            settings.supabase_url,\n            settings.supabase_service_role_key\n        )\n    return _supabase_admin_client\n```\n\n4. **Update .env.example**\n\nCreate `.env.example` file:\n```env\n# Supabase Configuration\nSUPABASE_URL=https://your-project.supabase.co\nSUPABASE_ANON_KEY=your-anon-key\nSUPABASE_SERVICE_ROLE_KEY=your-service-role-key\nSUPABASE_JWT_SECRET=your-jwt-secret\n\n# Rate Limiting\nDAILY_WORKFLOW_LIMIT=10\n\n# File Storage\nFILE_RETENTION_DAYS=30\nMAX_FILE_SIZE_MB=100\n```\n\n5. **Add .env to .gitignore** (if not already present)",
        "testStrategy": "1. Unit test: Verify settings load correctly from environment\n2. Integration test: Verify Supabase client can connect and query\n3. Test with missing environment variables (should fail gracefully)\n4. Verify admin client can bypass RLS\n5. Test connection pooling under load",
        "priority": "high",
        "dependencies": [
          1
        ],
        "status": "pending",
        "subtasks": []
      },
      {
        "id": 3,
        "title": "Implement Backend JWT Authentication Middleware",
        "description": "Create FastAPI middleware and dependencies to verify Supabase JWT tokens and extract user information for protected endpoints.",
        "details": "## Implementation Steps\n\n1. **Create auth dependencies module**\n\nCreate `fastapi_app/auth.py`:\n```python\nfrom typing import Optional\nfrom fastapi import Depends, HTTPException, status\nfrom fastapi.security import HTTPBearer, HTTPAuthorizationCredentials\nfrom jose import jwt, JWTError\nfrom pydantic import BaseModel\nfrom fastapi_app.config import get_settings\n\nsecurity = HTTPBearer(auto_error=False)\n\nclass UserContext(BaseModel):\n    \"\"\"Authenticated user context\"\"\"\n    user_id: str\n    email: Optional[str] = None\n    \n    class Config:\n        frozen = True\n\nasync def get_current_user(\n    credentials: HTTPAuthorizationCredentials = Depends(security)\n) -> UserContext:\n    \"\"\"Verify JWT and extract user info. Raises 401 if invalid.\"\"\"\n    if credentials is None:\n        raise HTTPException(\n            status_code=status.HTTP_401_UNAUTHORIZED,\n            detail=\"Authentication required\",\n            headers={\"WWW-Authenticate\": \"Bearer\"}\n        )\n    \n    try:\n        settings = get_settings()\n        payload = jwt.decode(\n            credentials.credentials,\n            settings.supabase_jwt_secret,\n            algorithms=[\"HS256\"],\n            audience=\"authenticated\"\n        )\n        user_id = payload.get(\"sub\")\n        email = payload.get(\"email\")\n        \n        if user_id is None:\n            raise HTTPException(\n                status_code=status.HTTP_401_UNAUTHORIZED,\n                detail=\"Invalid token payload\"\n            )\n        \n        return UserContext(user_id=user_id, email=email)\n    \n    except JWTError as e:\n        raise HTTPException(\n            status_code=status.HTTP_401_UNAUTHORIZED,\n            detail=f\"Invalid token: {str(e)}\"\n        )\n\nasync def get_optional_user(\n    credentials: HTTPAuthorizationCredentials = Depends(security)\n) -> Optional[UserContext]:\n    \"\"\"Get user if authenticated, None otherwise. For optional auth endpoints.\"\"\"\n    if credentials is None:\n        return None\n    try:\n        return await get_current_user(credentials)\n    except HTTPException:\n        return None\n```\n\n2. **Create user schema types**\n\nAdd to `fastapi_app/schemas.py`:\n```python\nclass UserProfile(BaseModel):\n    id: str\n    email: Optional[str] = None\n    display_name: Optional[str] = None\n    avatar_url: Optional[str] = None\n    created_at: Optional[str] = None\n\nclass AuthResponse(BaseModel):\n    user: UserProfile\n    access_token: str\n    refresh_token: str\n```\n\n3. **Example usage in protected endpoint**\n\n```python\nfrom fastapi_app.auth import get_current_user, UserContext\n\n@router.post(\"/protected-endpoint\")\nasync def protected_endpoint(\n    user: UserContext = Depends(get_current_user)\n):\n    # user.user_id is now available\n    return {\"message\": f\"Hello user {user.user_id}\"}\n```",
        "testStrategy": "1. Unit test JWT decoding with valid/invalid tokens\n2. Test expired token handling\n3. Test missing token returns 401\n4. Test malformed token returns 401\n5. Integration test: Verify token from Supabase Auth works\n6. Load test: Verify JWT verification performance < 100ms",
        "priority": "high",
        "dependencies": [
          2
        ],
        "status": "pending",
        "subtasks": []
      },
      {
        "id": 4,
        "title": "Implement Rate Limiting Service and Middleware",
        "description": "Create a rate limiting service that tracks daily workflow usage per user and enforces the 10 calls/day limit with appropriate error responses.",
        "details": "## Implementation Steps\n\n1. **Create rate limiting service**\n\nCreate `fastapi_app/services/rate_limiter.py`:\n```python\nfrom datetime import date, datetime, timezone\nfrom typing import Optional\nfrom pydantic import BaseModel\nfrom fastapi_app.supabase_client import get_supabase_admin_client\nfrom fastapi_app.config import get_settings\n\nclass UsageQuota(BaseModel):\n    used: int\n    limit: int\n    remaining: int\n    resets_at: str  # ISO timestamp of next midnight UTC\n\nclass RateLimitService:\n    def __init__(self):\n        self.settings = get_settings()\n    \n    async def get_daily_usage(self, user_id: str) -> int:\n        \"\"\"Get number of workflow calls made by user today\"\"\"\n        supabase = get_supabase_admin_client()\n        today = date.today().isoformat()\n        \n        result = supabase.table(\"usage_records\").select(\n            \"id\", count=\"exact\"\n        ).eq(\"user_id\", user_id).eq(\"date\", today).execute()\n        \n        return result.count or 0\n    \n    async def check_rate_limit(self, user_id: str) -> UsageQuota:\n        \"\"\"Check if user is within rate limit, return quota info\"\"\"\n        used = await self.get_daily_usage(user_id)\n        limit = self.settings.daily_workflow_limit\n        remaining = max(0, limit - used)\n        \n        # Calculate next midnight UTC\n        now = datetime.now(timezone.utc)\n        tomorrow = date.today()\n        from datetime import timedelta\n        tomorrow = datetime(now.year, now.month, now.day, tzinfo=timezone.utc) + timedelta(days=1)\n        \n        return UsageQuota(\n            used=used,\n            limit=limit,\n            remaining=remaining,\n            resets_at=tomorrow.isoformat()\n        )\n    \n    async def record_usage(self, user_id: str, workflow_type: str) -> None:\n        \"\"\"Record a workflow call for the user\"\"\"\n        supabase = get_supabase_admin_client()\n        \n        supabase.table(\"usage_records\").insert({\n            \"user_id\": user_id,\n            \"workflow_type\": workflow_type,\n            \"date\": date.today().isoformat()\n        }).execute()\n    \n    async def is_rate_limited(self, user_id: str) -> bool:\n        \"\"\"Quick check if user has exceeded their limit\"\"\"\n        quota = await self.check_rate_limit(user_id)\n        return quota.remaining <= 0\n\nrate_limiter = RateLimitService()\n```\n\n2. **Create rate limit dependency**\n\nAdd to `fastapi_app/auth.py`:\n```python\nfrom fastapi import Response\nfrom fastapi_app.services.rate_limiter import rate_limiter, UsageQuota\n\nasync def check_rate_limit(\n    response: Response,\n    user: UserContext = Depends(get_current_user)\n) -> UsageQuota:\n    \"\"\"Dependency that checks rate limit and adds headers\"\"\"\n    quota = await rate_limiter.check_rate_limit(user.user_id)\n    \n    # Add rate limit headers to response\n    response.headers[\"X-RateLimit-Limit\"] = str(quota.limit)\n    response.headers[\"X-RateLimit-Remaining\"] = str(quota.remaining)\n    response.headers[\"X-RateLimit-Reset\"] = quota.resets_at\n    \n    if quota.remaining <= 0:\n        raise HTTPException(\n            status_code=status.HTTP_429_TOO_MANY_REQUESTS,\n            detail={\n                \"error\": \"Rate limit exceeded\",\n                \"limit\": quota.limit,\n                \"resets_at\": quota.resets_at\n            },\n            headers={\n                \"Retry-After\": quota.resets_at,\n                \"X-RateLimit-Limit\": str(quota.limit),\n                \"X-RateLimit-Remaining\": \"0\",\n                \"X-RateLimit-Reset\": quota.resets_at\n            }\n        )\n    \n    return quota\n```\n\n3. **Create usage API endpoints**\n\nCreate `fastapi_app/routers/usage.py`:\n```python\nfrom fastapi import APIRouter, Depends, Response\nfrom fastapi_app.auth import get_current_user, UserContext\nfrom fastapi_app.services.rate_limiter import rate_limiter, UsageQuota\n\nrouter = APIRouter()\n\n@router.get(\"/quota\", response_model=UsageQuota)\nasync def get_quota(\n    response: Response,\n    user: UserContext = Depends(get_current_user)\n):\n    \"\"\"Get remaining quota for current user\"\"\"\n    quota = await rate_limiter.check_rate_limit(user.user_id)\n    \n    response.headers[\"X-RateLimit-Limit\"] = str(quota.limit)\n    response.headers[\"X-RateLimit-Remaining\"] = str(quota.remaining)\n    response.headers[\"X-RateLimit-Reset\"] = quota.resets_at\n    \n    return quota\n\n@router.get(\"/history\")\nasync def get_history(\n    user: UserContext = Depends(get_current_user),\n    days: int = 7\n):\n    \"\"\"Get usage history for past N days\"\"\"\n    # Implementation to query usage_records grouped by date\n    pass\n```",
        "testStrategy": "1. Unit test: Verify usage counting is accurate\n2. Test 429 response when limit exceeded\n3. Test rate limit headers are present in responses\n4. Test daily reset logic (mock time)\n5. Test concurrent requests don't cause race conditions\n6. Integration test: Full workflow with rate limiting",
        "priority": "high",
        "dependencies": [
          2,
          3
        ],
        "status": "pending",
        "subtasks": []
      },
      {
        "id": 5,
        "title": "Implement Backend File Management Service",
        "description": "Create a service to upload workflow outputs to Supabase Storage, track files in the database, and provide authenticated download URLs with 30-day expiration.",
        "details": "## Implementation Steps\n\n1. **Create file management service**\n\nCreate `fastapi_app/services/file_manager.py`:\n```python\nfrom datetime import datetime, timedelta, timezone\nfrom pathlib import Path\nfrom typing import List, Optional\nfrom uuid import uuid4\nfrom pydantic import BaseModel\nfrom fastapi_app.supabase_client import get_supabase_admin_client\nfrom fastapi_app.config import get_settings\n\nclass UserFile(BaseModel):\n    id: str\n    file_name: str\n    file_type: str\n    file_size: int\n    workflow_type: str\n    created_at: str\n    expires_at: str\n    download_url: Optional[str] = None\n\nclass FileManagerService:\n    BUCKET_NAME = \"user-files\"\n    \n    def __init__(self):\n        self.settings = get_settings()\n    \n    def _get_storage_path(self, user_id: str, workflow_type: str, filename: str) -> str:\n        \"\"\"Generate storage path: user_id/workflow_type/timestamp_filename\"\"\"\n        timestamp = datetime.now(timezone.utc).strftime(\"%Y%m%d_%H%M%S\")\n        return f\"{user_id}/{workflow_type}/{timestamp}_{filename}\"\n    \n    async def upload_file(\n        self,\n        user_id: str,\n        local_path: str,\n        workflow_type: str,\n        original_filename: Optional[str] = None\n    ) -> UserFile:\n        \"\"\"Upload a file to Supabase Storage and create database record\"\"\"\n        supabase = get_supabase_admin_client()\n        \n        path = Path(local_path)\n        if not path.exists():\n            raise FileNotFoundError(f\"File not found: {local_path}\")\n        \n        filename = original_filename or path.name\n        file_size = path.stat().st_size\n        \n        # Check file size limit\n        max_size = self.settings.max_file_size_mb * 1024 * 1024\n        if file_size > max_size:\n            raise ValueError(f\"File exceeds maximum size of {self.settings.max_file_size_mb}MB\")\n        \n        # Upload to storage\n        storage_path = self._get_storage_path(user_id, workflow_type, filename)\n        with open(local_path, \"rb\") as f:\n            supabase.storage.from_(self.BUCKET_NAME).upload(\n                storage_path,\n                f.read(),\n                file_options={\"content-type\": self._get_content_type(filename)}\n            )\n        \n        # Create database record\n        expires_at = datetime.now(timezone.utc) + timedelta(days=self.settings.file_retention_days)\n        \n        file_record = {\n            \"user_id\": user_id,\n            \"file_path\": storage_path,\n            \"file_name\": filename,\n            \"file_type\": path.suffix.lstrip(\".\"),\n            \"file_size\": file_size,\n            \"workflow_type\": workflow_type,\n            \"expires_at\": expires_at.isoformat()\n        }\n        \n        result = supabase.table(\"user_files\").insert(file_record).execute()\n        record = result.data[0]\n        \n        return UserFile(\n            id=record[\"id\"],\n            file_name=filename,\n            file_type=record[\"file_type\"],\n            file_size=file_size,\n            workflow_type=workflow_type,\n            created_at=record[\"created_at\"],\n            expires_at=record[\"expires_at\"]\n        )\n    \n    async def list_user_files(\n        self,\n        user_id: str,\n        workflow_type: Optional[str] = None\n    ) -> List[UserFile]:\n        \"\"\"List all files for a user, optionally filtered by workflow type\"\"\"\n        supabase = get_supabase_admin_client()\n        \n        query = supabase.table(\"user_files\").select(\"*\").eq(\"user_id\", user_id)\n        if workflow_type:\n            query = query.eq(\"workflow_type\", workflow_type)\n        \n        result = query.order(\"created_at\", desc=True).execute()\n        \n        files = []\n        for record in result.data:\n            # Generate signed URL for download\n            signed_url = supabase.storage.from_(self.BUCKET_NAME).create_signed_url(\n                record[\"file_path\"],\n                expires_in=3600  # 1 hour\n            )\n            \n            files.append(UserFile(\n                id=record[\"id\"],\n                file_name=record[\"file_name\"],\n                file_type=record[\"file_type\"],\n                file_size=record[\"file_size\"],\n                workflow_type=record[\"workflow_type\"],\n                created_at=record[\"created_at\"],\n                expires_at=record[\"expires_at\"],\n                download_url=signed_url[\"signedURL\"] if signed_url else None\n            ))\n        \n        return files\n    \n    async def get_download_url(self, user_id: str, file_id: str) -> str:\n        \"\"\"Get signed download URL for a specific file\"\"\"\n        supabase = get_supabase_admin_client()\n        \n        result = supabase.table(\"user_files\").select(\"file_path\").eq(\n            \"id\", file_id\n        ).eq(\"user_id\", user_id).single().execute()\n        \n        if not result.data:\n            raise FileNotFoundError(\"File not found or access denied\")\n        \n        signed_url = supabase.storage.from_(self.BUCKET_NAME).create_signed_url(\n            result.data[\"file_path\"],\n            expires_in=3600\n        )\n        \n        return signed_url[\"signedURL\"]\n    \n    async def delete_file(self, user_id: str, file_id: str) -> bool:\n        \"\"\"Delete a file from storage and database\"\"\"\n        supabase = get_supabase_admin_client()\n        \n        # Get file path first\n        result = supabase.table(\"user_files\").select(\"file_path\").eq(\n            \"id\", file_id\n        ).eq(\"user_id\", user_id).single().execute()\n        \n        if not result.data:\n            return False\n        \n        # Delete from storage\n        supabase.storage.from_(self.BUCKET_NAME).remove([result.data[\"file_path\"]])\n        \n        # Delete from database\n        supabase.table(\"user_files\").delete().eq(\"id\", file_id).execute()\n        \n        return True\n    \n    def _get_content_type(self, filename: str) -> str:\n        \"\"\"Get MIME type for file\"\"\"\n        ext = Path(filename).suffix.lower()\n        content_types = {\n            \".pdf\": \"application/pdf\",\n            \".pptx\": \"application/vnd.openxmlformats-officedocument.presentationml.presentation\",\n            \".mp4\": \"video/mp4\",\n            \".png\": \"image/png\",\n            \".jpg\": \"image/jpeg\",\n            \".jpeg\": \"image/jpeg\",\n            \".svg\": \"image/svg+xml\"\n        }\n        return content_types.get(ext, \"application/octet-stream\")\n\nfile_manager = FileManagerService()\n```\n\n2. **Create file API endpoints**\n\nCreate `fastapi_app/routers/files.py`:\n```python\nfrom fastapi import APIRouter, Depends, HTTPException\nfrom fastapi_app.auth import get_current_user, UserContext\nfrom fastapi_app.services.file_manager import file_manager, UserFile\nfrom typing import List, Optional\n\nrouter = APIRouter()\n\n@router.get(\"\", response_model=List[UserFile])\nasync def list_files(\n    user: UserContext = Depends(get_current_user),\n    workflow_type: Optional[str] = None\n):\n    \"\"\"List all files for the current user\"\"\"\n    return await file_manager.list_user_files(user.user_id, workflow_type)\n\n@router.get(\"/{file_id}/download\")\nasync def get_download_url(\n    file_id: str,\n    user: UserContext = Depends(get_current_user)\n):\n    \"\"\"Get signed download URL for a file\"\"\"\n    try:\n        url = await file_manager.get_download_url(user.user_id, file_id)\n        return {\"download_url\": url}\n    except FileNotFoundError:\n        raise HTTPException(status_code=404, detail=\"File not found\")\n\n@router.delete(\"/{file_id}\")\nasync def delete_file(\n    file_id: str,\n    user: UserContext = Depends(get_current_user)\n):\n    \"\"\"Delete a file\"\"\"\n    success = await file_manager.delete_file(user.user_id, file_id)\n    if not success:\n        raise HTTPException(status_code=404, detail=\"File not found\")\n    return {\"success\": True}\n```",
        "testStrategy": "1. Unit test file upload with various file types\n2. Test file size limit enforcement\n3. Test signed URL generation and expiration\n4. Test user can only access own files\n5. Test file deletion removes from both storage and DB\n6. Integration test: Upload from workflow output directory",
        "priority": "medium",
        "dependencies": [
          2,
          3
        ],
        "status": "pending",
        "subtasks": []
      },
      {
        "id": 6,
        "title": "Integrate Authentication with Existing Workflow Endpoints",
        "description": "Update existing Paper2Any workflow endpoints (paper2ppt, paper2video, pdf2ppt) to require authentication, check rate limits, and save outputs to user storage.",
        "details": "## Implementation Steps\n\n1. **Update paper2ppt.py router with auth**\n\nModify `fastapi_app/routers/paper2ppt.py`:\n```python\nfrom fastapi_app.auth import get_current_user, check_rate_limit, UserContext\nfrom fastapi_app.services.rate_limiter import rate_limiter, UsageQuota\nfrom fastapi_app.services.file_manager import file_manager\n\n# Update endpoint signatures to include auth dependencies\n@router.post(\"/pagecontent_json\", response_model=Paper2PPTResponse)\nasync def paper2ppt_pagecontent_json(\n    request: Request,\n    user: UserContext = Depends(get_current_user),\n    quota: UsageQuota = Depends(check_rate_limit),\n    # ... existing parameters ...\n):\n    # Existing implementation...\n    \n    # After workflow completes successfully, record usage\n    await rate_limiter.record_usage(user.user_id, \"paper2ppt\")\n    \n    # Upload output files to Supabase Storage\n    if resp.ppt_pptx_path:\n        await file_manager.upload_file(\n            user_id=user.user_id,\n            local_path=resp.ppt_pptx_path,\n            workflow_type=\"paper2ppt\"\n        )\n    \n    return resp\n```\n\n2. **Create a reusable decorator/dependency for workflow endpoints**\n\nCreate `fastapi_app/dependencies.py`:\n```python\nfrom typing import Callable, TypeVar\nfrom functools import wraps\nfrom fastapi import Depends, Response\nfrom fastapi_app.auth import get_current_user, UserContext\nfrom fastapi_app.services.rate_limiter import rate_limiter, UsageQuota\n\nclass WorkflowContext:\n    \"\"\"Context object passed to workflow endpoints\"\"\"\n    def __init__(self, user: UserContext, quota: UsageQuota):\n        self.user = user\n        self.quota = quota\n    \n    async def record_usage(self, workflow_type: str):\n        await rate_limiter.record_usage(self.user.user_id, workflow_type)\n\nasync def get_workflow_context(\n    response: Response,\n    user: UserContext = Depends(get_current_user)\n) -> WorkflowContext:\n    \"\"\"Combined dependency for workflow endpoints\"\"\"\n    quota = await rate_limiter.check_rate_limit(user.user_id)\n    \n    # Add rate limit headers\n    response.headers[\"X-RateLimit-Limit\"] = str(quota.limit)\n    response.headers[\"X-RateLimit-Remaining\"] = str(quota.remaining)\n    response.headers[\"X-RateLimit-Reset\"] = quota.resets_at\n    \n    if quota.remaining <= 0:\n        from fastapi import HTTPException, status\n        raise HTTPException(\n            status_code=status.HTTP_429_TOO_MANY_REQUESTS,\n            detail=\"Rate limit exceeded\"\n        )\n    \n    return WorkflowContext(user, quota)\n```\n\n3. **Update main.py to include new routers**\n\nModify `fastapi_app/main.py`:\n```python\nfrom fastapi_app.routers import usage, files\n\ndef create_app() -> FastAPI:\n    # ... existing code ...\n    \n    # Add new routers\n    app.include_router(usage.router, prefix=\"/api/usage\", tags=[\"usage\"])\n    app.include_router(files.router, prefix=\"/api/files\", tags=[\"files\"])\n    \n    return app\n```\n\n4. **Create helper for uploading workflow outputs**\n\nAdd to `fastapi_app/utils.py`:\n```python\nasync def save_workflow_outputs_to_storage(\n    user_id: str,\n    workflow_type: str,\n    output_paths: list[str]\n) -> list[UserFile]:\n    \"\"\"Upload all output files from a workflow to user storage\"\"\"\n    from fastapi_app.services.file_manager import file_manager\n    \n    uploaded_files = []\n    for path in output_paths:\n        if Path(path).exists():\n            file_record = await file_manager.upload_file(\n                user_id=user_id,\n                local_path=path,\n                workflow_type=workflow_type\n            )\n            uploaded_files.append(file_record)\n    \n    return uploaded_files\n```\n\n5. **Add user_id to output directory structure**\n\nModify `_create_run_dir_for_paper2ppt` to use user_id:\n```python\ndef _create_run_dir_for_paper2ppt(user_id: str, invite_code: Optional[str]) -> Path:\n    code = invite_code or \"default\"\n    run_dir = PROJECT_ROOT / BASE_OUTPUT_DIR / user_id / code / \"paper2ppt_input\"\n    run_dir.mkdir(parents=True, exist_ok=True)\n    return run_dir\n```",
        "testStrategy": "1. Test endpoint returns 401 without token\n2. Test endpoint returns 429 when rate limited\n3. Test rate limit headers are present in response\n4. Test usage is recorded after successful workflow\n5. Test output files are uploaded to storage\n6. Test existing functionality still works with auth\n7. End-to-end test: Login -> Execute workflow -> Check usage -> Download file",
        "priority": "high",
        "dependencies": [
          3,
          4,
          5
        ],
        "status": "pending",
        "subtasks": []
      },
      {
        "id": 7,
        "title": "Setup Frontend Supabase Client and Auth Context",
        "description": "Install Supabase JS client, configure environment variables, and create React context for authentication state management integrated with Zustand.",
        "details": "## Implementation Steps\n\n1. **Install Supabase JS SDK**\n\nIn `frontend-workflow/` directory:\n```bash\nnpm install @supabase/supabase-js\n```\n\n2. **Create environment configuration**\n\nCreate `frontend-workflow/.env.example`:\n```env\nVITE_SUPABASE_URL=https://your-project.supabase.co\nVITE_SUPABASE_ANON_KEY=your-anon-key\nVITE_API_URL=http://localhost:8000\n```\n\n3. **Create Supabase client**\n\nCreate `frontend-workflow/src/lib/supabase.ts`:\n```typescript\nimport { createClient } from '@supabase/supabase-js'\n\nconst supabaseUrl = import.meta.env.VITE_SUPABASE_URL\nconst supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY\n\nif (!supabaseUrl || !supabaseAnonKey) {\n  throw new Error('Missing Supabase environment variables')\n}\n\nexport const supabase = createClient(supabaseUrl, supabaseAnonKey, {\n  auth: {\n    autoRefreshToken: true,\n    persistSession: true,\n    detectSessionInUrl: true\n  }\n})\n```\n\n4. **Create auth store with Zustand**\n\nCreate `frontend-workflow/src/stores/authStore.ts`:\n```typescript\nimport { create } from 'zustand'\nimport { persist } from 'zustand/middleware'\nimport { User, Session } from '@supabase/supabase-js'\nimport { supabase } from '../lib/supabase'\n\ninterface UsageQuota {\n  used: number\n  limit: number\n  remaining: number\n  resets_at: string\n}\n\ninterface AuthState {\n  user: User | null\n  session: Session | null\n  loading: boolean\n  quota: UsageQuota | null\n  \n  // Actions\n  setUser: (user: User | null) => void\n  setSession: (session: Session | null) => void\n  setLoading: (loading: boolean) => void\n  setQuota: (quota: UsageQuota | null) => void\n  signOut: () => Promise<void>\n  refreshQuota: () => Promise<void>\n}\n\nexport const useAuthStore = create<AuthState>()(\n  persist(\n    (set, get) => ({\n      user: null,\n      session: null,\n      loading: true,\n      quota: null,\n      \n      setUser: (user) => set({ user }),\n      setSession: (session) => set({ session }),\n      setLoading: (loading) => set({ loading }),\n      setQuota: (quota) => set({ quota }),\n      \n      signOut: async () => {\n        await supabase.auth.signOut()\n        set({ user: null, session: null, quota: null })\n      },\n      \n      refreshQuota: async () => {\n        const { session } = get()\n        if (!session) return\n        \n        try {\n          const response = await fetch(\n            `${import.meta.env.VITE_API_URL}/api/usage/quota`,\n            {\n              headers: {\n                'Authorization': `Bearer ${session.access_token}`\n              }\n            }\n          )\n          if (response.ok) {\n            const quota = await response.json()\n            set({ quota })\n          }\n        } catch (error) {\n          console.error('Failed to fetch quota:', error)\n        }\n      }\n    }),\n    {\n      name: 'auth-storage',\n      partialize: (state) => ({}), // Don't persist - let Supabase handle it\n    }\n  )\n)\n```\n\n5. **Create auth provider component**\n\nCreate `frontend-workflow/src/components/AuthProvider.tsx`:\n```typescript\nimport { useEffect, ReactNode } from 'react'\nimport { supabase } from '../lib/supabase'\nimport { useAuthStore } from '../stores/authStore'\n\ninterface AuthProviderProps {\n  children: ReactNode\n}\n\nexport function AuthProvider({ children }: AuthProviderProps) {\n  const { setUser, setSession, setLoading, refreshQuota } = useAuthStore()\n  \n  useEffect(() => {\n    // Get initial session\n    supabase.auth.getSession().then(({ data: { session } }) => {\n      setSession(session)\n      setUser(session?.user ?? null)\n      setLoading(false)\n      if (session) {\n        refreshQuota()\n      }\n    })\n    \n    // Listen for auth changes\n    const { data: { subscription } } = supabase.auth.onAuthStateChange(\n      async (event, session) => {\n        setSession(session)\n        setUser(session?.user ?? null)\n        setLoading(false)\n        \n        if (event === 'SIGNED_IN') {\n          refreshQuota()\n        }\n      }\n    )\n    \n    return () => subscription.unsubscribe()\n  }, [])\n  \n  return <>{children}</>\n}\n```\n\n6. **Update main.tsx to wrap with AuthProvider**\n\nModify `frontend-workflow/src/main.tsx`:\n```typescript\nimport { AuthProvider } from './components/AuthProvider'\n\nReactDOM.createRoot(document.getElementById('root')!).render(\n  <React.StrictMode>\n    <AuthProvider>\n      <App />\n    </AuthProvider>\n  </React.StrictMode>,\n)\n```",
        "testStrategy": "1. Verify Supabase client initializes without errors\n2. Test auth state persists across page refreshes\n3. Test onAuthStateChange fires correctly\n4. Test quota refresh on login\n5. Test signOut clears all state\n6. Verify environment variables are loaded correctly",
        "priority": "high",
        "dependencies": [
          1
        ],
        "status": "pending",
        "subtasks": []
      },
      {
        "id": 8,
        "title": "Implement Frontend Authentication UI Components",
        "description": "Create login, registration, and OAuth button components with email/password forms, Google/GitHub OAuth integration, and password reset flow.",
        "details": "## Implementation Steps\n\n1. **Create Login Page component**\n\nCreate `frontend-workflow/src/components/auth/LoginPage.tsx`:\n```typescript\nimport { useState } from 'react'\nimport { supabase } from '../../lib/supabase'\nimport { Mail, Lock, AlertCircle, Github } from 'lucide-react'\n\ninterface LoginPageProps {\n  onSwitchToRegister: () => void\n}\n\nexport function LoginPage({ onSwitchToRegister }: LoginPageProps) {\n  const [email, setEmail] = useState('')\n  const [password, setPassword] = useState('')\n  const [loading, setLoading] = useState(false)\n  const [error, setError] = useState<string | null>(null)\n  \n  const handleEmailLogin = async (e: React.FormEvent) => {\n    e.preventDefault()\n    setLoading(true)\n    setError(null)\n    \n    const { error } = await supabase.auth.signInWithPassword({\n      email,\n      password\n    })\n    \n    if (error) {\n      setError(error.message)\n    }\n    setLoading(false)\n  }\n  \n  const handleOAuthLogin = async (provider: 'google' | 'github') => {\n    setLoading(true)\n    const { error } = await supabase.auth.signInWithOAuth({\n      provider,\n      options: {\n        redirectTo: window.location.origin\n      }\n    })\n    if (error) {\n      setError(error.message)\n      setLoading(false)\n    }\n  }\n  \n  return (\n    <div className=\"min-h-screen flex items-center justify-center bg-[#0a0a1a]\">\n      <div className=\"glass-dark p-8 rounded-xl w-full max-w-md border border-white/10\">\n        <h2 className=\"text-2xl font-bold text-white mb-6 text-center\">\n          Sign in to DataFlow Agent\n        </h2>\n        \n        {error && (\n          <div className=\"mb-4 p-3 bg-red-500/20 border border-red-500/50 rounded-lg flex items-center gap-2 text-red-300\">\n            <AlertCircle size={18} />\n            <span className=\"text-sm\">{error}</span>\n          </div>\n        )}\n        \n        <form onSubmit={handleEmailLogin} className=\"space-y-4\">\n          <div>\n            <label className=\"block text-sm text-gray-400 mb-1\">Email</label>\n            <div className=\"relative\">\n              <Mail className=\"absolute left-3 top-1/2 -translate-y-1/2 text-gray-500\" size={18} />\n              <input\n                type=\"email\"\n                value={email}\n                onChange={(e) => setEmail(e.target.value)}\n                className=\"w-full pl-10 pr-4 py-2 bg-white/5 border border-white/10 rounded-lg text-white focus:outline-none focus:border-primary-500\"\n                placeholder=\"you@example.com\"\n                required\n              />\n            </div>\n          </div>\n          \n          <div>\n            <label className=\"block text-sm text-gray-400 mb-1\">Password</label>\n            <div className=\"relative\">\n              <Lock className=\"absolute left-3 top-1/2 -translate-y-1/2 text-gray-500\" size={18} />\n              <input\n                type=\"password\"\n                value={password}\n                onChange={(e) => setPassword(e.target.value)}\n                className=\"w-full pl-10 pr-4 py-2 bg-white/5 border border-white/10 rounded-lg text-white focus:outline-none focus:border-primary-500\"\n                placeholder=\"••••••••\"\n                required\n                minLength={8}\n              />\n            </div>\n          </div>\n          \n          <button\n            type=\"submit\"\n            disabled={loading}\n            className=\"w-full py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg font-medium disabled:opacity-50\"\n          >\n            {loading ? 'Signing in...' : 'Sign in'}\n          </button>\n        </form>\n        \n        <div className=\"my-6 flex items-center\">\n          <div className=\"flex-1 border-t border-white/10\" />\n          <span className=\"px-4 text-gray-500 text-sm\">or continue with</span>\n          <div className=\"flex-1 border-t border-white/10\" />\n        </div>\n        \n        <div className=\"grid grid-cols-2 gap-3\">\n          <button\n            onClick={() => handleOAuthLogin('google')}\n            disabled={loading}\n            className=\"flex items-center justify-center gap-2 py-2 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg text-white\"\n          >\n            <svg className=\"w-5 h-5\" viewBox=\"0 0 24 24\">\n              {/* Google icon SVG */}\n            </svg>\n            Google\n          </button>\n          <button\n            onClick={() => handleOAuthLogin('github')}\n            disabled={loading}\n            className=\"flex items-center justify-center gap-2 py-2 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg text-white\"\n          >\n            <Github size={20} />\n            GitHub\n          </button>\n        </div>\n        \n        <p className=\"mt-6 text-center text-gray-400 text-sm\">\n          Don't have an account?{' '}\n          <button\n            onClick={onSwitchToRegister}\n            className=\"text-primary-400 hover:underline\"\n          >\n            Sign up\n          </button>\n        </p>\n      </div>\n    </div>\n  )\n}\n```\n\n2. **Create Registration Page component**\n\nCreate `frontend-workflow/src/components/auth/RegisterPage.tsx`:\n```typescript\nimport { useState } from 'react'\nimport { supabase } from '../../lib/supabase'\nimport { Mail, Lock, User, AlertCircle, CheckCircle } from 'lucide-react'\n\ninterface RegisterPageProps {\n  onSwitchToLogin: () => void\n}\n\nexport function RegisterPage({ onSwitchToLogin }: RegisterPageProps) {\n  const [email, setEmail] = useState('')\n  const [password, setPassword] = useState('')\n  const [displayName, setDisplayName] = useState('')\n  const [loading, setLoading] = useState(false)\n  const [error, setError] = useState<string | null>(null)\n  const [success, setSuccess] = useState(false)\n  \n  const handleRegister = async (e: React.FormEvent) => {\n    e.preventDefault()\n    setLoading(true)\n    setError(null)\n    \n    if (password.length < 8) {\n      setError('Password must be at least 8 characters')\n      setLoading(false)\n      return\n    }\n    \n    const { error } = await supabase.auth.signUp({\n      email,\n      password,\n      options: {\n        data: {\n          full_name: displayName\n        }\n      }\n    })\n    \n    if (error) {\n      setError(error.message)\n    } else {\n      setSuccess(true)\n    }\n    setLoading(false)\n  }\n  \n  if (success) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center bg-[#0a0a1a]\">\n        <div className=\"glass-dark p-8 rounded-xl w-full max-w-md border border-white/10 text-center\">\n          <CheckCircle className=\"mx-auto text-green-500 mb-4\" size={48} />\n          <h2 className=\"text-xl font-bold text-white mb-2\">Check your email</h2>\n          <p className=\"text-gray-400 mb-4\">\n            We've sent a verification link to {email}\n          </p>\n          <button\n            onClick={onSwitchToLogin}\n            className=\"text-primary-400 hover:underline\"\n          >\n            Back to login\n          </button>\n        </div>\n      </div>\n    )\n  }\n  \n  return (\n    <div className=\"min-h-screen flex items-center justify-center bg-[#0a0a1a]\">\n      <div className=\"glass-dark p-8 rounded-xl w-full max-w-md border border-white/10\">\n        <h2 className=\"text-2xl font-bold text-white mb-6 text-center\">\n          Create your account\n        </h2>\n        \n        {error && (\n          <div className=\"mb-4 p-3 bg-red-500/20 border border-red-500/50 rounded-lg flex items-center gap-2 text-red-300\">\n            <AlertCircle size={18} />\n            <span className=\"text-sm\">{error}</span>\n          </div>\n        )}\n        \n        <form onSubmit={handleRegister} className=\"space-y-4\">\n          <div>\n            <label className=\"block text-sm text-gray-400 mb-1\">Display Name</label>\n            <div className=\"relative\">\n              <User className=\"absolute left-3 top-1/2 -translate-y-1/2 text-gray-500\" size={18} />\n              <input\n                type=\"text\"\n                value={displayName}\n                onChange={(e) => setDisplayName(e.target.value)}\n                className=\"w-full pl-10 pr-4 py-2 bg-white/5 border border-white/10 rounded-lg text-white focus:outline-none focus:border-primary-500\"\n                placeholder=\"John Doe\"\n              />\n            </div>\n          </div>\n          \n          <div>\n            <label className=\"block text-sm text-gray-400 mb-1\">Email</label>\n            <div className=\"relative\">\n              <Mail className=\"absolute left-3 top-1/2 -translate-y-1/2 text-gray-500\" size={18} />\n              <input\n                type=\"email\"\n                value={email}\n                onChange={(e) => setEmail(e.target.value)}\n                className=\"w-full pl-10 pr-4 py-2 bg-white/5 border border-white/10 rounded-lg text-white focus:outline-none focus:border-primary-500\"\n                placeholder=\"you@example.com\"\n                required\n              />\n            </div>\n          </div>\n          \n          <div>\n            <label className=\"block text-sm text-gray-400 mb-1\">Password</label>\n            <div className=\"relative\">\n              <Lock className=\"absolute left-3 top-1/2 -translate-y-1/2 text-gray-500\" size={18} />\n              <input\n                type=\"password\"\n                value={password}\n                onChange={(e) => setPassword(e.target.value)}\n                className=\"w-full pl-10 pr-4 py-2 bg-white/5 border border-white/10 rounded-lg text-white focus:outline-none focus:border-primary-500\"\n                placeholder=\"••••••••\"\n                required\n                minLength={8}\n              />\n            </div>\n            <p className=\"text-xs text-gray-500 mt-1\">Minimum 8 characters</p>\n          </div>\n          \n          <button\n            type=\"submit\"\n            disabled={loading}\n            className=\"w-full py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg font-medium disabled:opacity-50\"\n          >\n            {loading ? 'Creating account...' : 'Create account'}\n          </button>\n        </form>\n        \n        <p className=\"mt-6 text-center text-gray-400 text-sm\">\n          Already have an account?{' '}\n          <button\n            onClick={onSwitchToLogin}\n            className=\"text-primary-400 hover:underline\"\n          >\n            Sign in\n          </button>\n        </p>\n      </div>\n    </div>\n  )\n}\n```\n\n3. **Create AuthModal for seamless UX**\n\nCreate `frontend-workflow/src/components/auth/AuthModal.tsx` for in-app authentication without page navigation.\n\n4. **Configure OAuth providers in Supabase**\n\nIn Supabase Dashboard:\n- Enable Google OAuth and add Client ID/Secret\n- Enable GitHub OAuth and add Client ID/Secret\n- Set redirect URL to `https://your-project.supabase.co/auth/v1/callback`",
        "testStrategy": "1. Test email registration flow end-to-end\n2. Test email login with correct/incorrect credentials\n3. Test OAuth redirect and callback handling\n4. Test password validation (min 8 chars)\n5. Test error message display\n6. Test loading states\n7. Visual test: Components match existing UI style",
        "priority": "high",
        "dependencies": [
          7
        ],
        "status": "pending",
        "subtasks": []
      },
      {
        "id": 9,
        "title": "Implement Protected Routes and Usage Display",
        "description": "Add route protection to redirect unauthenticated users to login, and display usage quota in the header/sidebar with warnings when approaching limits.",
        "details": "## Implementation Steps\n\n1. **Create ProtectedRoute component**\n\nCreate `frontend-workflow/src/components/auth/ProtectedRoute.tsx`:\n```typescript\nimport { ReactNode } from 'react'\nimport { useAuthStore } from '../../stores/authStore'\nimport { LoginPage } from './LoginPage'\nimport { RegisterPage } from './RegisterPage'\nimport { useState } from 'react'\n\ninterface ProtectedRouteProps {\n  children: ReactNode\n}\n\nexport function ProtectedRoute({ children }: ProtectedRouteProps) {\n  const { user, loading } = useAuthStore()\n  const [authMode, setAuthMode] = useState<'login' | 'register'>('login')\n  \n  if (loading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center bg-[#0a0a1a]\">\n        <div className=\"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-500\" />\n      </div>\n    )\n  }\n  \n  if (!user) {\n    return authMode === 'login' \n      ? <LoginPage onSwitchToRegister={() => setAuthMode('register')} />\n      : <RegisterPage onSwitchToLogin={() => setAuthMode('login')} />\n  }\n  \n  return <>{children}</>\n}\n```\n\n2. **Create QuotaDisplay component**\n\nCreate `frontend-workflow/src/components/QuotaDisplay.tsx`:\n```typescript\nimport { useEffect } from 'react'\nimport { useAuthStore } from '../stores/authStore'\nimport { Zap, AlertTriangle } from 'lucide-react'\n\nexport function QuotaDisplay() {\n  const { quota, refreshQuota, user } = useAuthStore()\n  \n  useEffect(() => {\n    if (user) {\n      refreshQuota()\n      // Refresh quota every 5 minutes\n      const interval = setInterval(refreshQuota, 5 * 60 * 1000)\n      return () => clearInterval(interval)\n    }\n  }, [user])\n  \n  if (!quota) return null\n  \n  const isLow = quota.remaining <= 3\n  const isExhausted = quota.remaining === 0\n  \n  return (\n    <div className={`flex items-center gap-2 px-3 py-1.5 rounded-lg ${\n      isExhausted \n        ? 'bg-red-500/20 border border-red-500/50' \n        : isLow \n          ? 'bg-yellow-500/20 border border-yellow-500/50'\n          : 'bg-white/5 border border-white/10'\n    }`}>\n      {isLow || isExhausted ? (\n        <AlertTriangle size={16} className={isExhausted ? 'text-red-400' : 'text-yellow-400'} />\n      ) : (\n        <Zap size={16} className=\"text-primary-400\" />\n      )}\n      <span className={`text-sm ${\n        isExhausted ? 'text-red-300' : isLow ? 'text-yellow-300' : 'text-gray-300'\n      }`}>\n        {quota.remaining}/{quota.limit} calls\n      </span>\n    </div>\n  )\n}\n```\n\n3. **Create UserMenu component**\n\nCreate `frontend-workflow/src/components/UserMenu.tsx`:\n```typescript\nimport { useState, useRef, useEffect } from 'react'\nimport { useAuthStore } from '../stores/authStore'\nimport { User, LogOut, Settings, FileText } from 'lucide-react'\n\nexport function UserMenu() {\n  const { user, signOut } = useAuthStore()\n  const [isOpen, setIsOpen] = useState(false)\n  const menuRef = useRef<HTMLDivElement>(null)\n  \n  useEffect(() => {\n    const handleClickOutside = (event: MouseEvent) => {\n      if (menuRef.current && !menuRef.current.contains(event.target as Node)) {\n        setIsOpen(false)\n      }\n    }\n    document.addEventListener('mousedown', handleClickOutside)\n    return () => document.removeEventListener('mousedown', handleClickOutside)\n  }, [])\n  \n  if (!user) return null\n  \n  return (\n    <div className=\"relative\" ref={menuRef}>\n      <button\n        onClick={() => setIsOpen(!isOpen)}\n        className=\"flex items-center gap-2 px-3 py-1.5 rounded-lg bg-white/5 hover:bg-white/10 border border-white/10\"\n      >\n        {user.user_metadata?.avatar_url ? (\n          <img \n            src={user.user_metadata.avatar_url} \n            alt=\"Avatar\" \n            className=\"w-6 h-6 rounded-full\"\n          />\n        ) : (\n          <User size={18} className=\"text-gray-400\" />\n        )}\n        <span className=\"text-sm text-gray-300 max-w-[120px] truncate\">\n          {user.user_metadata?.full_name || user.email}\n        </span>\n      </button>\n      \n      {isOpen && (\n        <div className=\"absolute right-0 mt-2 w-48 glass-dark rounded-lg border border-white/10 shadow-xl z-50\">\n          <div className=\"p-2\">\n            <button\n              onClick={() => { /* Navigate to files */ }}\n              className=\"w-full flex items-center gap-2 px-3 py-2 text-sm text-gray-300 hover:bg-white/10 rounded-lg\"\n            >\n              <FileText size={16} />\n              My Files\n            </button>\n            <button\n              onClick={() => { /* Navigate to settings */ }}\n              className=\"w-full flex items-center gap-2 px-3 py-2 text-sm text-gray-300 hover:bg-white/10 rounded-lg\"\n            >\n              <Settings size={16} />\n              Settings\n            </button>\n            <hr className=\"my-2 border-white/10\" />\n            <button\n              onClick={signOut}\n              className=\"w-full flex items-center gap-2 px-3 py-2 text-sm text-red-400 hover:bg-red-500/10 rounded-lg\"\n            >\n              <LogOut size={16} />\n              Sign out\n            </button>\n          </div>\n        </div>\n      )}\n    </div>\n  )\n}\n```\n\n4. **Update App.tsx header to include auth components**\n\nModify `frontend-workflow/src/App.tsx`:\n```typescript\nimport { ProtectedRoute } from './components/auth/ProtectedRoute'\nimport { QuotaDisplay } from './components/QuotaDisplay'\nimport { UserMenu } from './components/UserMenu'\n\nfunction App() {\n  return (\n    <ProtectedRoute>\n      <div className=\"w-screen h-screen bg-[#0a0a1a] overflow-hidden relative\">\n        {/* ... existing content ... */}\n        <header className=\"absolute top-0 left-0 right-0 h-16 glass-dark border-b border-white/10 z-10\">\n          <div className=\"h-full px-6 flex items-center justify-between\">\n            {/* Logo - existing */}\n            \n            {/* Right side - add auth components */}\n            <div className=\"flex items-center gap-4\">\n              {/* Page tabs - existing */}\n              <QuotaDisplay />\n              <UserMenu />\n            </div>\n          </div>\n        </header>\n        {/* ... rest of existing content ... */}\n      </div>\n    </ProtectedRoute>\n  )\n}\n```\n\n5. **Add rate limit warning before workflow execution**\n\nUpdate workflow pages to check quota before allowing execution:\n```typescript\nconst { quota, refreshQuota } = useAuthStore()\n\nconst handleExecuteWorkflow = async () => {\n  if (quota?.remaining === 0) {\n    alert(`Daily limit reached. Resets at ${new Date(quota.resets_at).toLocaleTimeString()}`)\n    return\n  }\n  // Execute workflow...\n  refreshQuota() // Refresh after execution\n}\n```",
        "testStrategy": "1. Test unauthenticated users see login page\n2. Test authenticated users see main app\n3. Test loading state while checking auth\n4. Test quota display shows correct values\n5. Test warning appears when quota is low (<=3)\n6. Test user menu opens/closes correctly\n7. Test sign out clears auth state\n8. Test workflow blocked when quota exhausted",
        "priority": "medium",
        "dependencies": [
          7,
          8
        ],
        "status": "pending",
        "subtasks": []
      },
      {
        "id": 10,
        "title": "Implement Frontend File Management Page",
        "description": "Create a file list page showing user's generated files with download buttons, delete functionality, and file type/workflow filtering.",
        "details": "## Implementation Steps\n\n1. **Create API client for files**\n\nCreate `frontend-workflow/src/lib/api.ts`:\n```typescript\nimport { supabase } from './supabase'\n\nconst API_URL = import.meta.env.VITE_API_URL\n\nasync function getAuthHeaders(): Promise<HeadersInit> {\n  const { data: { session } } = await supabase.auth.getSession()\n  return {\n    'Authorization': `Bearer ${session?.access_token}`,\n    'Content-Type': 'application/json'\n  }\n}\n\nexport interface UserFile {\n  id: string\n  file_name: string\n  file_type: string\n  file_size: number\n  workflow_type: string\n  created_at: string\n  expires_at: string\n  download_url?: string\n}\n\nexport const filesApi = {\n  async list(workflowType?: string): Promise<UserFile[]> {\n    const params = workflowType ? `?workflow_type=${workflowType}` : ''\n    const response = await fetch(`${API_URL}/api/files${params}`, {\n      headers: await getAuthHeaders()\n    })\n    if (!response.ok) throw new Error('Failed to fetch files')\n    return response.json()\n  },\n  \n  async getDownloadUrl(fileId: string): Promise<string> {\n    const response = await fetch(`${API_URL}/api/files/${fileId}/download`, {\n      headers: await getAuthHeaders()\n    })\n    if (!response.ok) throw new Error('Failed to get download URL')\n    const data = await response.json()\n    return data.download_url\n  },\n  \n  async delete(fileId: string): Promise<void> {\n    const response = await fetch(`${API_URL}/api/files/${fileId}`, {\n      method: 'DELETE',\n      headers: await getAuthHeaders()\n    })\n    if (!response.ok) throw new Error('Failed to delete file')\n  }\n}\n```\n\n2. **Create FilesPage component**\n\nCreate `frontend-workflow/src/components/FilesPage.tsx`:\n```typescript\nimport { useState, useEffect } from 'react'\nimport { filesApi, UserFile } from '../lib/api'\nimport { FileText, Download, Trash2, Filter, Clock, HardDrive } from 'lucide-react'\n\nconst WORKFLOW_TYPES = [\n  { value: '', label: 'All Workflows' },\n  { value: 'paper2ppt', label: 'Paper2PPT' },\n  { value: 'paper2video', label: 'Paper2Video' },\n  { value: 'pdf2ppt', label: 'PDF2PPT' },\n  { value: 'paper2figure', label: 'Paper2Figure' }\n]\n\nfunction formatFileSize(bytes: number): string {\n  if (bytes < 1024) return `${bytes} B`\n  if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`\n  return `${(bytes / (1024 * 1024)).toFixed(1)} MB`\n}\n\nfunction formatDate(dateStr: string): string {\n  return new Date(dateStr).toLocaleDateString('en-US', {\n    month: 'short',\n    day: 'numeric',\n    hour: '2-digit',\n    minute: '2-digit'\n  })\n}\n\nfunction daysUntilExpiry(expiresAt: string): number {\n  const diff = new Date(expiresAt).getTime() - Date.now()\n  return Math.ceil(diff / (1000 * 60 * 60 * 24))\n}\n\nexport function FilesPage() {\n  const [files, setFiles] = useState<UserFile[]>([])\n  const [loading, setLoading] = useState(true)\n  const [filter, setFilter] = useState('')\n  const [deletingId, setDeletingId] = useState<string | null>(null)\n  \n  useEffect(() => {\n    loadFiles()\n  }, [filter])\n  \n  const loadFiles = async () => {\n    setLoading(true)\n    try {\n      const data = await filesApi.list(filter || undefined)\n      setFiles(data)\n    } catch (error) {\n      console.error('Failed to load files:', error)\n    }\n    setLoading(false)\n  }\n  \n  const handleDownload = async (file: UserFile) => {\n    try {\n      const url = await filesApi.getDownloadUrl(file.id)\n      window.open(url, '_blank')\n    } catch (error) {\n      console.error('Failed to download:', error)\n    }\n  }\n  \n  const handleDelete = async (fileId: string) => {\n    if (!confirm('Are you sure you want to delete this file?')) return\n    \n    setDeletingId(fileId)\n    try {\n      await filesApi.delete(fileId)\n      setFiles(files.filter(f => f.id !== fileId))\n    } catch (error) {\n      console.error('Failed to delete:', error)\n    }\n    setDeletingId(null)\n  }\n  \n  const getFileIcon = (fileType: string) => {\n    const icons: Record<string, string> = {\n      'pdf': '📄',\n      'pptx': '📊',\n      'mp4': '🎬',\n      'png': '🖼️',\n      'svg': '🎨'\n    }\n    return icons[fileType] || '📁'\n  }\n  \n  return (\n    <div className=\"p-6\">\n      <div className=\"flex items-center justify-between mb-6\">\n        <h1 className=\"text-2xl font-bold text-white\">My Files</h1>\n        \n        <div className=\"flex items-center gap-2\">\n          <Filter size={18} className=\"text-gray-400\" />\n          <select\n            value={filter}\n            onChange={(e) => setFilter(e.target.value)}\n            className=\"bg-white/5 border border-white/10 rounded-lg px-3 py-1.5 text-sm text-gray-300 focus:outline-none focus:border-primary-500\"\n          >\n            {WORKFLOW_TYPES.map(type => (\n              <option key={type.value} value={type.value}>{type.label}</option>\n            ))}\n          </select>\n        </div>\n      </div>\n      \n      {loading ? (\n        <div className=\"flex items-center justify-center py-12\">\n          <div className=\"animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary-500\" />\n        </div>\n      ) : files.length === 0 ? (\n        <div className=\"text-center py-12\">\n          <FileText className=\"mx-auto text-gray-600 mb-4\" size={48} />\n          <p className=\"text-gray-400\">No files yet</p>\n          <p className=\"text-gray-500 text-sm mt-1\">Files you generate will appear here</p>\n        </div>\n      ) : (\n        <div className=\"space-y-3\">\n          {files.map(file => {\n            const daysLeft = daysUntilExpiry(file.expires_at)\n            \n            return (\n              <div\n                key={file.id}\n                className=\"glass-dark border border-white/10 rounded-lg p-4 flex items-center justify-between\"\n              >\n                <div className=\"flex items-center gap-4\">\n                  <span className=\"text-2xl\">{getFileIcon(file.file_type)}</span>\n                  <div>\n                    <h3 className=\"text-white font-medium\">{file.file_name}</h3>\n                    <div className=\"flex items-center gap-3 text-xs text-gray-500 mt-1\">\n                      <span className=\"flex items-center gap-1\">\n                        <HardDrive size={12} />\n                        {formatFileSize(file.file_size)}\n                      </span>\n                      <span>•</span>\n                      <span>{file.workflow_type}</span>\n                      <span>•</span>\n                      <span>{formatDate(file.created_at)}</span>\n                      <span>•</span>\n                      <span className={`flex items-center gap-1 ${\n                        daysLeft <= 7 ? 'text-yellow-500' : ''\n                      }`}>\n                        <Clock size={12} />\n                        Expires in {daysLeft} days\n                      </span>\n                    </div>\n                  </div>\n                </div>\n                \n                <div className=\"flex items-center gap-2\">\n                  <button\n                    onClick={() => handleDownload(file)}\n                    className=\"p-2 hover:bg-white/10 rounded-lg text-primary-400\"\n                    title=\"Download\"\n                  >\n                    <Download size={18} />\n                  </button>\n                  <button\n                    onClick={() => handleDelete(file.id)}\n                    disabled={deletingId === file.id}\n                    className=\"p-2 hover:bg-red-500/10 rounded-lg text-red-400 disabled:opacity-50\"\n                    title=\"Delete\"\n                  >\n                    <Trash2 size={18} />\n                  </button>\n                </div>\n              </div>\n            )\n          })}\n        </div>\n      )}\n    </div>\n  )\n}\n```\n\n3. **Add Files page to navigation**\n\nUpdate App.tsx to include FilesPage in routing/navigation:\n```typescript\nconst [activePage, setActivePage] = useState<'paper2figure' | 'paper2ppt' | 'pdf2ppt' | 'ppt2polish' | 'files'>('paper2figure')\n\n// Add button in header\n<button\n  onClick={() => setActivePage('files')}\n  className={`px-3 py-1.5 rounded-full text-sm ${...}`}\n>\n  My Files\n</button>\n\n// Add in main content\n{activePage === 'files' && <FilesPage />}\n```",
        "testStrategy": "1. Test file list loads correctly\n2. Test filtering by workflow type\n3. Test download opens file in new tab\n4. Test delete shows confirmation and removes file\n5. Test empty state when no files\n6. Test loading state\n7. Test expiry warning for files expiring soon\n8. Test file size formatting\n9. Visual test: Page matches app style",
        "priority": "medium",
        "dependencies": [
          7,
          9
        ],
        "status": "pending",
        "subtasks": []
      },
      {
        "id": 11,
        "title": "Implement Supabase Scheduled Function for File Cleanup",
        "description": "Create a Supabase Edge Function that runs daily to delete expired files (older than 30 days) from both storage and database.",
        "details": "## Implementation Steps\n\n1. **Create Edge Function for file cleanup**\n\nCreate Supabase Edge Function `supabase/functions/cleanup-expired-files/index.ts`:\n```typescript\nimport { serve } from 'https://deno.land/std@0.168.0/http/server.ts'\nimport { createClient } from 'https://esm.sh/@supabase/supabase-js@2'\n\nconst corsHeaders = {\n  'Access-Control-Allow-Origin': '*',\n  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',\n}\n\nserve(async (req) => {\n  // Handle CORS preflight\n  if (req.method === 'OPTIONS') {\n    return new Response('ok', { headers: corsHeaders })\n  }\n  \n  try {\n    // Create Supabase admin client\n    const supabaseUrl = Deno.env.get('SUPABASE_URL')!\n    const supabaseServiceKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!\n    \n    const supabase = createClient(supabaseUrl, supabaseServiceKey, {\n      auth: {\n        autoRefreshToken: false,\n        persistSession: false\n      }\n    })\n    \n    // Find expired files\n    const { data: expiredFiles, error: selectError } = await supabase\n      .from('user_files')\n      .select('id, file_path, user_id')\n      .lt('expires_at', new Date().toISOString())\n    \n    if (selectError) {\n      throw selectError\n    }\n    \n    if (!expiredFiles || expiredFiles.length === 0) {\n      return new Response(\n        JSON.stringify({ message: 'No expired files to clean up', deleted: 0 }),\n        { headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\n      )\n    }\n    \n    console.log(`Found ${expiredFiles.length} expired files to delete`)\n    \n    // Delete files from storage\n    const filePaths = expiredFiles.map(f => f.file_path)\n    const { error: storageError } = await supabase\n      .storage\n      .from('user-files')\n      .remove(filePaths)\n    \n    if (storageError) {\n      console.error('Storage deletion error:', storageError)\n      // Continue with database cleanup even if storage fails\n    }\n    \n    // Delete records from database\n    const fileIds = expiredFiles.map(f => f.id)\n    const { error: deleteError } = await supabase\n      .from('user_files')\n      .delete()\n      .in('id', fileIds)\n    \n    if (deleteError) {\n      throw deleteError\n    }\n    \n    return new Response(\n      JSON.stringify({\n        message: 'Cleanup completed',\n        deleted: expiredFiles.length,\n        file_paths: filePaths\n      }),\n      { headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\n    )\n    \n  } catch (error) {\n    console.error('Cleanup error:', error)\n    return new Response(\n      JSON.stringify({ error: error.message }),\n      { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\n    )\n  }\n})\n```\n\n2. **Deploy the Edge Function**\n\n```bash\n# From project root\nsupabase functions deploy cleanup-expired-files\n```\n\n3. **Set up scheduled invocation via Supabase Cron**\n\nIn Supabase Dashboard > Database > Extensions:\n- Enable the `pg_cron` extension\n\nThen in SQL Editor:\n```sql\n-- Create a scheduled job to run cleanup daily at midnight UTC\nSELECT cron.schedule(\n  'cleanup-expired-files',\n  '0 0 * * *',  -- Every day at midnight UTC\n  $$\n  SELECT\n    net.http_post(\n      url:='https://your-project.supabase.co/functions/v1/cleanup-expired-files',\n      headers:='{\"Content-Type\": \"application/json\", \"Authorization\": \"Bearer your-service-role-key\"}'::jsonb,\n      body:='{}'::jsonb\n    ) AS request_id;\n  $$\n);\n```\n\nAlternatively, use Supabase's built-in cron (if available in your plan).\n\n4. **Add logging table for cleanup audits** (optional)\n\n```sql\nCREATE TABLE public.cleanup_logs (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  run_at TIMESTAMPTZ DEFAULT NOW(),\n  files_deleted INTEGER,\n  status TEXT,\n  details JSONB\n);\n```\n\n5. **Alternative: Use PostgreSQL function directly**\n\nIf Edge Functions are not available, create a database function:\n```sql\nCREATE OR REPLACE FUNCTION cleanup_expired_files()\nRETURNS INTEGER AS $$\nDECLARE\n  deleted_count INTEGER;\nBEGIN\n  -- Delete from database (storage cleanup would need separate handling)\n  WITH deleted AS (\n    DELETE FROM public.user_files\n    WHERE expires_at < NOW()\n    RETURNING id\n  )\n  SELECT COUNT(*) INTO deleted_count FROM deleted;\n  \n  RETURN deleted_count;\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER;\n\n-- Schedule with pg_cron\nSELECT cron.schedule(\n  'cleanup-expired-files-db',\n  '0 0 * * *',\n  'SELECT cleanup_expired_files()'\n);\n```",
        "testStrategy": "1. Test function finds expired files correctly\n2. Test function deletes from both storage and database\n3. Test function handles no expired files gracefully\n4. Test function handles storage deletion errors\n5. Test cron schedule triggers function daily\n6. Monitor cleanup_logs table for execution history\n7. Test with manually expired test files",
        "priority": "low",
        "dependencies": [
          1,
          5
        ],
        "status": "pending",
        "subtasks": []
      },
      {
        "id": 12,
        "title": "End-to-End Testing and Documentation",
        "description": "Create comprehensive integration tests for the full authentication and file management flow, and update documentation with setup instructions.",
        "details": "## Implementation Steps\n\n1. **Create integration test suite**\n\nCreate `tests/test_auth_flow.py`:\n```python\nimport pytest\nimport httpx\nfrom supabase import create_client\nimport os\n\nSUPABASE_URL = os.getenv(\"SUPABASE_URL\")\nSUPABASE_ANON_KEY = os.getenv(\"SUPABASE_ANON_KEY\")\nAPI_URL = os.getenv(\"API_URL\", \"http://localhost:8000\")\n\n@pytest.fixture\nasync def test_user():\n    \"\"\"Create a test user and return auth token\"\"\"\n    supabase = create_client(SUPABASE_URL, SUPABASE_ANON_KEY)\n    \n    email = f\"test_{uuid.uuid4().hex[:8]}@example.com\"\n    password = \"testpassword123\"\n    \n    result = supabase.auth.sign_up({\n        \"email\": email,\n        \"password\": password\n    })\n    \n    yield {\n        \"user_id\": result.user.id,\n        \"access_token\": result.session.access_token,\n        \"email\": email\n    }\n    \n    # Cleanup: Delete test user\n    admin_client = create_client(SUPABASE_URL, os.getenv(\"SUPABASE_SERVICE_ROLE_KEY\"))\n    admin_client.auth.admin.delete_user(result.user.id)\n\n\n@pytest.mark.asyncio\nasync def test_protected_endpoint_requires_auth():\n    \"\"\"Test that protected endpoints return 401 without token\"\"\"\n    async with httpx.AsyncClient() as client:\n        response = await client.get(f\"{API_URL}/api/usage/quota\")\n        assert response.status_code == 401\n\n\n@pytest.mark.asyncio\nasync def test_protected_endpoint_with_auth(test_user):\n    \"\"\"Test that protected endpoints work with valid token\"\"\"\n    async with httpx.AsyncClient() as client:\n        response = await client.get(\n            f\"{API_URL}/api/usage/quota\",\n            headers={\"Authorization\": f\"Bearer {test_user['access_token']}\"}\n        )\n        assert response.status_code == 200\n        data = response.json()\n        assert \"limit\" in data\n        assert \"remaining\" in data\n\n\n@pytest.mark.asyncio\nasync def test_rate_limit_enforcement(test_user):\n    \"\"\"Test that rate limiting works correctly\"\"\"\n    async with httpx.AsyncClient() as client:\n        headers = {\"Authorization\": f\"Bearer {test_user['access_token']}\"}\n        \n        # Make requests up to the limit\n        for i in range(10):\n            response = await client.get(f\"{API_URL}/api/usage/quota\", headers=headers)\n            # Simulate workflow call that increments usage\n            # (would need a test endpoint or mock)\n        \n        # Next request should be rate limited\n        # ...\n\n\n@pytest.mark.asyncio\nasync def test_file_upload_and_list(test_user):\n    \"\"\"Test file upload and listing flow\"\"\"\n    # This would test the full file management flow\n    pass\n```\n\n2. **Create frontend E2E tests with Playwright**\n\nCreate `frontend-workflow/e2e/auth.spec.ts`:\n```typescript\nimport { test, expect } from '@playwright/test'\n\ntest.describe('Authentication Flow', () => {\n  test('shows login page for unauthenticated users', async ({ page }) => {\n    await page.goto('/')\n    await expect(page.getByText('Sign in to DataFlow Agent')).toBeVisible()\n  })\n  \n  test('can register new account', async ({ page }) => {\n    await page.goto('/')\n    await page.click('text=Sign up')\n    await page.fill('[type=\"email\"]', `test_${Date.now()}@example.com`)\n    await page.fill('[type=\"password\"]', 'testpassword123')\n    await page.click('text=Create account')\n    await expect(page.getByText('Check your email')).toBeVisible()\n  })\n  \n  test('can login with email/password', async ({ page }) => {\n    // Use a pre-created test user\n    await page.goto('/')\n    await page.fill('[type=\"email\"]', process.env.TEST_USER_EMAIL!)\n    await page.fill('[type=\"password\"]', process.env.TEST_USER_PASSWORD!)\n    await page.click('text=Sign in')\n    await expect(page.getByText('DataFlow Agent')).toBeVisible()\n  })\n  \n  test('shows quota after login', async ({ page }) => {\n    // Login first, then check quota display\n    // ...\n    await expect(page.getByText(/\\/10 calls/)).toBeVisible()\n  })\n})\n```\n\n3. **Create setup documentation**\n\nCreate `docs/auth-setup.md`:\n```markdown\n# Paper2Any User Management Setup Guide\n\n## Prerequisites\n- Supabase account\n- Node.js 18+\n- Python 3.10+\n\n## 1. Supabase Setup\n\n### Create Project\n1. Go to https://supabase.com/dashboard\n2. Create new project\n3. Save the project URL and anon key\n\n### Run Database Migrations\n1. Navigate to SQL Editor in Supabase Dashboard\n2. Run the migration scripts from `supabase/migrations/`\n\n### Configure OAuth Providers\n1. Go to Authentication > Providers\n2. Enable Google and configure Client ID/Secret\n3. Enable GitHub and configure Client ID/Secret\n\n### Create Storage Bucket\n1. Go to Storage\n2. Create bucket named \"user-files\"\n3. Set to private\n\n## 2. Backend Configuration\n\n### Environment Variables\nCreate `.env` file in project root:\n```\nSUPABASE_URL=https://your-project.supabase.co\nSUPABASE_ANON_KEY=your-anon-key\nSUPABASE_SERVICE_ROLE_KEY=your-service-role-key\nSUPABASE_JWT_SECRET=your-jwt-secret\n```\n\n### Install Dependencies\n```bash\npip install supabase python-jose[cryptography]\n```\n\n## 3. Frontend Configuration\n\n### Environment Variables\nCreate `frontend-workflow/.env`:\n```\nVITE_SUPABASE_URL=https://your-project.supabase.co\nVITE_SUPABASE_ANON_KEY=your-anon-key\nVITE_API_URL=http://localhost:8000\n```\n\n### Install Dependencies\n```bash\ncd frontend-workflow\nnpm install @supabase/supabase-js\n```\n\n## 4. Running the Application\n\n```bash\n# Start backend\nuvicorn fastapi_app.main:app --reload --port 8000\n\n# Start frontend\ncd frontend-workflow && npm run dev\n```\n\n## 5. Testing\n\n```bash\n# Run backend tests\npytest tests/test_auth_flow.py\n\n# Run frontend E2E tests\ncd frontend-workflow && npx playwright test\n```\n```\n\n4. **Update CLAUDE.md with new endpoints**\n\nAdd documentation about new API endpoints and authentication requirements.",
        "testStrategy": "1. Run full test suite passes\n2. Documentation can be followed by new developer\n3. All happy path flows work end-to-end\n4. Error cases handled gracefully\n5. OAuth flows work in browser\n6. Rate limiting works across browser refresh\n7. File cleanup runs successfully",
        "priority": "medium",
        "dependencies": [
          6,
          9,
          10,
          11
        ],
        "status": "pending",
        "subtasks": []
      }
    ],
    "metadata": {
      "created": "2025-12-26T17:31:20.185Z",
      "updated": "2025-12-26T17:31:20.185Z",
      "description": "Tasks for master context"
    }
  }
}